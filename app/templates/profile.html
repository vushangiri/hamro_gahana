{% extends "base.html" %}
{% block content %}

<div class="card rounded-3 border-0 shadow p-4">
  <h6 class="section-header mb-3 mt-2">My Profile & Store</h6>

  <form method="post" enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <!-- User Details -->
    <h6 class="text-primary-color fw-semibold mb-2">Account Information</h6>

    <div class="mb-3">
      <label>{{ form.phone.label }}</label>
      {{ form.phone(class="form-control") }}
      {% for error in form.phone.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <div class="mb-3">
      <label>{{ form.email.label }}</label>
      {{ form.email(class="form-control") }}
      {% for error in form.email.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <div class="mb-3">
      <label>{{ form.password.label }}</label>
      {{ form.password(class="form-control") }}
      {% for error in form.password.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
      <div class="form-text text-muted">Leave blank if you don't want to change your password.</div>
    </div>

    <div class="mb-3">
      <label>{{ form.confirm.label }}</label>
      {{ form.confirm(class="form-control") }}
      {% for error in form.confirm.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <hr>

    <!-- Store Details -->
    <h6 class="text-primary-color fw-semibold mb-2">Store Information</h6>

    <div class="mb-3">
      <label>{{ form.store_name.label }}</label>
      {{ form.store_name(class="form-control") }}
      {% for error in form.store_name.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <div class="mb-3">
      <label>{{ form.store_address.label }}</label>
      {{ form.store_address(class="form-control") }}
      {% for error in form.store_address.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <div class="mb-3">
      <label>Store Location:</label>
      <div id="map" style="height: 300px; border: 1px solid #ddd;"></div>
    </div>

    {{ form.latitude(type="hidden", id="latitude") }}
    {{ form.longitude(type="hidden", id="longitude") }}

    <div class="mb-3">
      <label>{{ form.phone2.label }}</label>
      {{ form.phone2(class="form-control") }}
      {% for error in form.phone2.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <div class="mb-3">
      <label>Current Store Logo:</label><br>
      {% if store.logo_filename %}
        <img src="{{ url_for('static', filename='uploads/' ~ store.logo_filename) }}" width="100" class="rounded shadow-sm mb-2">
      {% else %}
        <p class="text-muted">No logo uploaded.</p>
      {% endif %}
    </div>

    <div class="mb-3">
      <label>{{ form.store_logo.label }}</label>
      {{ form.store_logo(class="form-control") }}
      <div class="form-text text-muted">Upload to replace current logo.</div>
      {% for error in form.store_logo.errors %}
        <div class="text-danger">{{ error }}</div>
      {% endfor %}
    </div>

    <div class="mt-3">
      {{ form.submit(class="btn btn-app fw-bold") }}
    </div>
  </form>
</div>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const latField = document.getElementById("latitude");
  const lngField = document.getElementById("longitude");
  const initialLat = latField.value || 27.7;
  const initialLng = lngField.value || 85.3;

  var map = L.map('map').setView([initialLat, initialLng], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  var marker = L.marker([initialLat, initialLng], { draggable: true }).addTo(map);

  marker.on('move', function(e) {
    latField.value = e.latlng.lat;
    lngField.value = e.latlng.lng;
  });

  if (navigator.geolocation && (!latField.value || !lngField.value)) {
    navigator.geolocation.getCurrentPosition(function(pos) {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      map.setView([lat, lng], 16);
      marker.setLatLng([lat, lng]);
      latField.value = lat;
      lngField.value = lng;
    });
  }
});
</script>

{% endblock %}
